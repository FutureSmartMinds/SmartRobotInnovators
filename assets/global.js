(function() {

  // helper to wait for Blockly to be available
  function waitForBlockly(cb, timeout = 10000) {
    const start = Date.now();
    (function check() {
      if (window.Blockly && window.Blockly.inject && window.Blockly.JavaScript) return cb();
      if (Date.now() - start > timeout) {
        console.error("Glowbit: Blockly failed to load within timeout.");
        return;
      }
      setTimeout(check, 50);
    })();
  }

  waitForBlockly(function() {

    // avoid double-initialization
    if (window.Glowbit && window.Glowbit._initialized) {
      console.log("Glowbit: already initialized");
      return;
    }

    // --------------------
    // Internal state
    // --------------------
    const state = {
      canvases: {}, // canvasId -> {canvas, ctx, pixelSize, padding, gridSize, pixels}
      queue: [],    // commands queue
      running: false,
      eventHandlers: { A: [], B: [], shake: [], tilt_up: [], tilt_down: [], tilt_left: [], tilt_right: [] },
      defaultColor: "#00ff00",
      brightness: 255
    };

    // --------------------
    // Fonts & icons for display (5x7 / 8x8)
    // --------------------
    const FONT5x7 = {
      "A":["01110","10001","10001","11111","10001","10001","10001"],
      "B":["11110","10001","10001","11110","10001","10001","11110"],
      "C":["01110","10001","10000","10000","10000","10001","01110"],
      "D":["11100","10010","10001","10001","10001","10010","11100"],
      "E":["11111","10000","10000","11110","10000","10000","11111"],
      "F":["11111","10000","10000","11110","10000","10000","10000"],
      "G":["01110","10001","10000","10011","10001","10001","01110"],
      "H":["10001","10001","10001","11111","10001","10001","10001"],
      "I":["01110","00100","00100","00100","00100","00100","01110"],
      "J":["00111","00010","00010","00010","10010","10010","01100"],
      "K":["10001","10010","10100","11000","10100","10010","10001"],
      "L":["10000","10000","10000","10000","10000","10000","11111"],
      "M":["10001","11011","10101","10101","10001","10001","10001"],
      "N":["10001","10001","11001","10101","10011","10001","10001"],
      "O":["01110","10001","10001","10001","10001","10001","01110"],
      "P":["11110","10001","10001","11110","10000","10000","10000"],
      "Q":["01110","10001","10001","10001","10101","10010","01101"],
      "R":["11110","10001","10001","11110","10100","10010","10001"],
      "S":["01111","10000","10000","01110","00001","00001","11110"],
      "T":["11111","00100","00100","00100","00100","00100","00100"],
      "U":["10001","10001","10001","10001","10001","10001","01110"],
      "V":["10001","10001","10001","10001","10001","01010","00100"],
      "W":["10001","10001","10001","10101","10101","110
