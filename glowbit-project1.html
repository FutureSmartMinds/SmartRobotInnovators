<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GlowBit Project 1 â€“ Liamâ€™s Mood Maker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Blockly + Glowbit core -->
  <script src="lib/blockly_compressed.js"></script>
  <script src="lib/blocks_compressed.js"></script>
  <script src="lib/javascript_compressed.js"></script>
  <script src="lib/msg/en.js"></script>
  <script src="assets/global.js"></script>
  <script src="lib/blockly_xml_patch.js"></script>

  <style>
    .gb-wrapper {max-width:1100px;margin:0 auto;font-family:"Segoe UI",Roboto,Arial,sans-serif;}
    .gb-header {text-align:center;background:#e6f9ff;color:#00A1D6;font-size:22px;font-weight:800;
                padding:6px 10px;border-radius:8px;margin-bottom:8px;box-shadow:0 1px 4px rgba(0,0,0,0.08);}
    .gb-header .highlight {color:#7B2CBF;}
    .gb-intro {text-align:center;font-size:16px;line-height:1.5;margin:0 0 10px;color:#374151;
               background:#e0f2fe;border-radius:6px;padding:10px 12px;box-shadow:0 1px 3px rgba(0,0,0,0.06);}
    .didyouknow {margin-top:18px;background:#fef9c3;border:2px solid #facc15;padding:10px 12px;
                 border-radius:12px;color:#713f12;font-size:13px;font-weight:600;position:relative;
                 box-shadow:0 2px 5px rgba(0,0,0,0.06);}
    .didyouknow::before {content:"";position:absolute;top:-10px;left:20px;border-width:0 10px 10px 10px;
                         border-style:solid;border-color:transparent transparent #fef9c3 transparent;}

    .nav-btns {display:flex;justify-content:space-between;gap:8px;margin-top:10px;flex-wrap:wrap;}
    .gb-btn {padding:8px 14px;border:none;border-radius:6px;font-weight:700;cursor:pointer;flex:1;text-align:center;}
    .gb-btn.next {background:#00A1D6;color:#fff;}
    .gb-btn.back {background:#6B7280;color:#fff;}
    .gb-btn.check {background:#10B981;color:#fff;display:block;margin:12px auto 0;} /* centered */

    /* Solution modal */
    #solutionModalP1 {display:none;position:fixed;top:60px;right:20px;width:640px;max-width:42%;
                     background:#fff;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.28);
                     z-index:12000;overflow:hidden;user-select:none;}
    #solutionHeaderP1 {cursor:move;padding:10px 12px;background:#00A1D6;color:#fff;font-weight:700;
                      text-align:left;border-radius:10px 10px 0 0;display:flex;justify-content:space-between;align-items:center;}
    #solutionWorkspaceP1 {height:360px;width:100%;border-top:1px solid #eee;background:#fafafa;}
    #solutionFooterP1 {text-align:center;padding:12px;background:#fff;}
    #solutionFooterP1 button {background:#00A1D6;color:#fff;border:none;border-radius:8px;
                              padding:8px 18px;cursor:pointer;font-weight:700;}
    @media (max-width:900px){
      #solutionModalP1{left:10px;right:10px;width:auto;max-width:calc(100% - 20px);top:40px;}
      #solutionWorkspaceP1{height:260px;}
    }
  </style>
</head>

<body>
  <div class="gb-wrapper">
    <div class="gb-header">
      ðŸŒŸ <span class="highlight">Project 1</span>: Liamâ€™s GlowBit Mood Maker â€” <span class="highlight">Is GlowBit Happy or Sad?</span>
    </div>

    <p class="gb-intro">
      Create a happy face, a sad face, and switch moods with buttons A and B â€” now centered on the 8Ã—8 grid!
    </p>

    <div id="glowbit-project1-step1"></div>
  </div>

  <!-- Solution Modal -->
  <div id="solutionModalP1" aria-hidden="true" role="dialog">
    <div id="solutionHeaderP1">
      <div>âœ… Correct Setup â€” GlowBit Mood Maker</div>
      <button id="solutionCloseP1" title="Close">âœ•</button>
    </div>
    <div id="solutionWorkspaceP1" aria-label="Correct solution workspace"></div>
    <div id="solutionFooterP1"><button id="solutionCloseBtnP1">Close</button></div>
  </div>

  <script>
  (function waitForGlow(){
    if(!(window.Glowbit && window.Blockly)) return setTimeout(waitForGlow,120);

    /* -------------------------------------------
       1) Build solutionJson programmatically
       - Shows: On Button A -> clear + 5 plot (smile)
               On Button B -> clear + 5 plot (sad)
       - All coords centered for 8Ã—8 (offset +1,+1)
    --------------------------------------------*/
    const smile = [[1,2],[2,3],[3,3],[4,3],[5,2]]; // centered from (0,1)(1,2)(2,2)(3,2)(4,1)
    const sad   = [[1,4],[2,3],[3,3],[4,3],[5,4]]; // centered from (0,3)(1,2)(2,2)(3,2)(4,3)

    function chainPlots(coords){
      let first=null, curr=null;
      coords.forEach(([x,y])=>{
        const blk = {"type":"plot","fields":{"X":x,"Y":y}};
        if(!first){ first=blk; curr=blk; }
        else { curr.next = {"block": blk}; curr = blk; }
      });
      return first;
    }
    function doClearThenPlots(coords){
      const chain = chainPlots(coords);
      return { "block": { "type":"clear_screen", "next": (chain? {"block": chain} : undefined) } };
    }
    const solutionJson = {
      "blocks": {
        "languageVersion": 0,
        "blocks": [
          {
            "type": "on_button_pressed",
            "fields": {"BTN":"A"},
            "x": 24, "y": 20,
            "inputs": { "DO": doClearThenPlots(smile) }
          },
          {
            "type": "on_button_pressed",
            "fields": {"BTN":"B"},
            "x": 260, "y": 20,
            "inputs": { "DO": doClearThenPlots(sad) }
          }
        ]
      }
    };

    /* -------------------------------------------
       2) Create Lesson UI (re-uses your global.js)
    --------------------------------------------*/
    const lesson = Glowbit.createLessonUI('glowbit-project1-step1', {
      title:'', instructions:'', pixelSize:28, defaultJson:null
    });
    if(lesson && lesson.workspace) lesson.workspace.clear();

    /* -------------------------------------------
       3) Auto-paginate sidebar to fill to the
          bottom of the Blockly workspace height
          (uses #...-editor height as the target)
    --------------------------------------------*/
    const stepCards = [
      // Step 1 â€“ Happy (centered)
      `<h3 style="text-align:center;color:#00A1D6;">Step 1: Happy Face (Centered) ðŸ˜Š</h3>
       <div style="margin:10px 0;padding:10px;border-radius:8px;background:#0284C7;color:#fff;">
       â€¢ From <strong>LED</strong>, drag five <strong>Plot (x,y)</strong> blocks.<br>
       â€¢ Use centered coords on the 8Ã—8 grid: <code>(1,2) (2,3) (3,3) (4,3) (5,2)</code>.<br>
       â€¢ Add <strong>on start</strong> from Basic and (optionally) try it there to preview.<br>
       â€¢ Click <strong>Run</strong> and verify the smile is centered.</div>`,

      // Step 2 â€“ Sad (centered)
      `<h3 style="text-align:center;color:#00A1D6;">Step 2: Sad Face (Centered) ðŸ˜¢</h3>
       <div style="margin:10px 0;padding:10px;border-radius:8px;background:#7B2CBF;color:#fff;">
       â€¢ Duplicate your five Plot blocks.<br>
       â€¢ Use centered coords for sad mouth: <code>(1,4) (2,3) (3,3) (4,3) (5,4)</code>.<br>
       â€¢ (Optional) Preview in <strong>on start</strong> to check shape.</div>`,

      // Step 3 â€“ Switch moods
      `<h3 style="text-align:center;color:#00A1D6;">Step 3: Switch Moods ðŸ”„</h3>
       <div style="margin:10px 0;padding:10px;border-radius:8px;background:#00A1D6;color:#fff;">
       â€¢ Add <strong>on button A pressed</strong> (Input), put <strong>clear screen</strong> first,<br>
       &nbsp;&nbsp;then the 5 Plot blocks for the <strong>happy</strong> face.<br>
       â€¢ Add <strong>on button B pressed</strong>, put <strong>clear screen</strong> first,<br>
       &nbsp;&nbsp;then the 5 Plot blocks for the <strong>sad</strong> face.<br>
       â€¢ Click <strong>Run</strong>, then press A or B to change moods!</div>`,

      // Tips to help fill first page neatly
      `<div style="margin:10px 0;padding:10px;border-radius:8px;background:#065F46;color:#fff;">
       âœ… Tip: If a face looks offset, double-check the x,y pairs.<br>
       âœ… Tip: Use <strong>Plot</strong> (no color) to match the solution view.</div>`,

      // Last page: Check Setup + Did you know
      `<button id="check-setup-btnP1" class="gb-btn check">âœ… Check Your Setup</button>
       <div class="didyouknow">ðŸ’¡ <strong>Did you know?</strong> Emotions on robots are often shown with LEDs and sounds â€” youâ€™re doing the same with GlowBit!</div>`
    ];

    function paginateToWorkspaceHeight(){
      const sidebar = document.querySelector('#glowbit-project1-step1 .glowbit-left');
      if(!sidebar) return;

      // Target = Blockly editor box height (fallback 520)
      const editor = document.getElementById('glowbit-project1-step1-editor');
      const targetH = (editor && editor.offsetHeight) ? editor.offsetHeight : 520;

      // Build pages by measuring offscreen
      const measurer = document.createElement('div');
      measurer.style.visibility='hidden';
      measurer.style.position='absolute';
      measurer.style.left='-9999px';
      measurer.style.top='-9999px';
      measurer.style.width = (sidebar.clientWidth || 320) + 'px';
      document.body.appendChild(measurer);

      const pages = [];
      let currentPage = [];
      measurer.innerHTML = '';

      // Small bottom reserve for nav buttons (~56px)
      const reserve = 56;

      stepCards.forEach(html=>{
        const card = document.createElement('div');
        card.innerHTML = html;
        measurer.appendChild(card);

        const tooTall = measurer.scrollHeight > (targetH - reserve);
        if(tooTall){
          // start new page with this card
          if(currentPage.length===0){
            // If single card itself exceeds target, force page anyway
            pages.push([html]);
            measurer.innerHTML='';
          } else {
            pages.push([...currentPage]);
            currentPage = [html];
            measurer.innerHTML='';
            // re-measure currentPage
            currentPage.forEach(h=>{
              const c=document.createElement('div'); c.innerHTML=h; measurer.appendChild(c);
            });
          }
        } else {
          currentPage.push(html);
        }
      });
      if(currentPage.length) pages.push(currentPage);

      document.body.removeChild(measurer);

      // Render with Back/Next
      function render(idx){
        sidebar.innerHTML = pages[idx].join('');
        const nav = document.createElement('div');
        nav.className='nav-btns';
        if(idx>0){
          const back=document.createElement('button');
          back.textContent='â¬… Back'; back.className='gb-btn back';
          back.onclick=()=>render(idx-1);
          nav.appendChild(back);
        }
        if(idx<pages.length-1){
          const next=document.createElement('button');
          next.textContent='Next âžœ'; next.className='gb-btn next';
          next.onclick=()=>render(idx+1);
          nav.appendChild(next);
        }
        sidebar.appendChild(nav);
      }
      render(0);
    }

    // First render + on resize (debounced)
    paginateToWorkspaceHeight();
    let _rt=null;
    window.addEventListener('resize',()=>{
      clearTimeout(_rt);
      _rt=setTimeout(paginateToWorkspaceHeight,150);
    });

    /* -------------------------------------------
       4) Check Your Setup (loads our solutionJson)
    --------------------------------------------*/
    const modal=document.getElementById('solutionModalP1');
    document.addEventListener('click',function(e){
      if(e.target && e.target.id==='check-setup-btnP1'){
        modal.style.display='block';
        modal.setAttribute('aria-hidden','false');
        if(!window._solutionWorkspaceP1){
          const wsDiv=document.getElementById('solutionWorkspaceP1');
          window._solutionWorkspaceP1=Blockly.inject(wsDiv,{readOnly:true,scrollbars:true,toolbox:null});
          Blockly.serialization.workspaces.load(solutionJson, window._solutionWorkspaceP1);
        }
      }
      if(e.target && (e.target.id==='solutionCloseP1'||e.target.id==='solutionCloseBtnP1')){
        modal.style.display='none';
        modal.setAttribute('aria-hidden','true');
      }
    });

    // Friendly hello on the simulator
    if(typeof Glowbit.showIcon==='function') Glowbit.showIcon('smile');

    console.log('âœ… Project 1 â€“ Mood Maker ready with auto-paginated sidebar + centered setup.');
  })();
  </script>
</body>
</html>
