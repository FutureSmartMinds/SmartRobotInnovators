<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GlowBit Step 5 ‚Äì Light Up a Row</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Blockly core + Global Glowbit setup -->
  <script src="lib/blockly_compressed.js"></script>
  <script src="lib/blocks_compressed.js"></script>
  <script src="lib/javascript_compressed.js"></script>
  <script src="lib/msg/en.js"></script>
  <script src="assets/global.js"></script>

  <style>
    .gb-wrapper { max-width:1100px; margin:0 auto; font-family:"Segoe UI",Roboto,Arial,sans-serif; }
    .gb-header { text-align:center; background:#e6f9ff; color:#00A1D6; font-size:22px; font-weight:800;
                 padding:6px 10px; border-radius:8px; margin-bottom:8px; box-shadow:0 1px 4px rgba(0,0,0,0.08);}
    .gb-header .highlight { color:#7B2CBF; }
    .gb-intro { text-align:center; font-size:16px; line-height:1.5; margin:0 0 10px; color:#374151;
                background:#e0f2fe; border-radius:6px; padding:10px 12px; box-shadow:0 1px 3px rgba(0,0,0,0.06);}
    #glowbit-step5 .glowbit-playground { max-height:540px; overflow-y:auto!important; border-radius:6px; }
    .didyouknow { margin-top:18px; background:#fef9c3; border:2px solid #facc15; padding:10px 12px;
                  border-radius:12px; color:#713f12; font-size:13px; font-weight:600; position:relative;
                  box-shadow:0 2px 5px rgba(0,0,0,0.06);}
    .didyouknow::before { content:""; position:absolute; top:-10px; left:20px; border-width:0 10px 10px 10px;
                           border-style:solid; border-color:transparent transparent #fef9c3 transparent;}

    /* Solution modal */
    #solutionModal { display:none; position:fixed; top:60px; right:20px; width:640px; max-width:42%;
                     background:#fff; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,0.28);
                     z-index:12000; overflow:hidden; user-select:none;}
    #solutionHeader { cursor:move; padding:10px 12px; background:#00A1D6; color:#fff; font-weight:700;
                      text-align:left; border-radius:10px 10px 0 0; display:flex; justify-content:space-between;
                      align-items:center;}
    #solutionTitle { font-size:15px; }
    #solutionClose { cursor:pointer; font-size:20px; line-height:1; padding:2px 8px; border-radius:6px;
                     color:#fff; background:transparent; border:none;}
    #solutionWorkspace { height:360px; width:100%; border-top:1px solid #eee; background:#fafafa; }
    #solutionFooter { text-align:center; padding:12px; background:#fff;}
    #solutionFooter button { background:#00A1D6; color:#fff; border:none; border-radius:8px;
                              padding:8px 18px; cursor:pointer; font-weight:700;}
    @media (max-width:900px){ #solutionModal{ left:10px; right:10px; width:auto; max-width:calc(100% - 20px);
                                             top:40px;} #solutionWorkspace{ height:260px;} }
  </style>
</head>

<body>
  <div class="gb-wrapper">
    <div class="gb-header">
      üåü <span class="highlight">Step 5</span>: Light Up a Row ‚Äî GlowBit‚Äôs Shining Line
    </div>

    <p class="gb-intro">
      Now it‚Äôs time to play with individual pixels! You‚Äôll clear the screen, then light up several pixels
      in a row ‚Äî that‚Äôs how pictures and patterns are made on GlowBit.
    </p>

    <div id="glowbit-step5"></div>
  </div>

  <!-- ‚úÖ Check-your-setup modal -->
  <div id="solutionModal" aria-hidden="true" role="dialog">
    <div id="solutionHeader">
      <div id="solutionTitle">‚úÖ Correct Setup ‚Äî Step 5</div>
      <button id="solutionClose" title="Close">‚úï</button>
    </div>
    <div id="solutionWorkspace" aria-label="Correct solution workspace"></div>
    <div id="solutionFooter"><button id="solutionCloseBtn">Close</button></div>
  </div>

  <script>
  (function waitForGlow(){
    if(!(window.Glowbit && window.Blockly)) return setTimeout(waitForGlow,120);

    /* --- Solution XML: clear screen + coloured row --- */
    const solutionXml = `<xml xmlns="https://developers.google.com/blockly/xml">
      <block type="on_start" x="20" y="20">
        <statement name="DO">
          <block type="clear_screen">
            <next>
              <block type="set_pixel_color">
                <field name="X">0</field><field name="Y">2</field><field name="COLOR">3</field>
                <next><block type="set_pixel_color"><field name="X">1</field><field name="Y">2</field><field name="COLOR">3</field>
                  <next><block type="set_pixel_color"><field name="X">2</field><field name="Y">2</field><field name="COLOR">3</field>
                    <next><block type="set_pixel_color"><field name="X">3</field><field name="Y">2</field><field name="COLOR">3</field>
                      <next><block type="set_pixel_color"><field name="X">4</field><field name="Y">2</field><field name="COLOR">3</field>
                        <next><block type="set_pixel_color"><field name="X">5</field><field name="Y">2</field><field name="COLOR">3</field>
                          <next><block type="set_pixel_color"><field name="X">6</field><field name="Y">2</field><field name="COLOR">3</field>
                            <next><block type="set_pixel_color"><field name="X">7</field><field name="Y">2</field><field name="COLOR">3</field></block></next>
                          </block></next>
                        </block></next>
                      </block></next>
                    </block></next>
                  </block></next>
                </block>
              </block>
            </next>
          </block>
        </statement>
      </block>
    </xml>`;

    const lesson = Glowbit.createLessonUI('glowbit-step5',{
      title:'',instructions:'',pixelSize:28,defaultXml:null
    });
    window._lesson_step5 = lesson;

    /* --- Sidebar --- */
    function overrideSidebar(){
      const container=document.querySelector('#glowbit-step5');
      if(!container)return;
      const sidebar=Array.from(container.querySelectorAll('*')).find(el=>{
        if(!el||!el.innerText)return false;
        const t=el.innerText.trim();
        return t.includes('GlowBit Lesson')||t.includes('Follow the steps')||/^Step\s*\d+:/.test(t);
      });
      if(!sidebar)return;

      sidebar.style.background='#e6f9ff';
      sidebar.style.borderRadius='10px';
      sidebar.style.padding='12px';
      sidebar.style.color='#00A1D6';
      sidebar.style.fontSize='14px';
      sidebar.style.fontWeight='500';
      sidebar.style.boxShadow='0 0 8px rgba(0,0,0,0.08)';

      const card='margin:10px 0;padding:10px;border-radius:8px;background:#0284C7;color:#fff;font-weight:600;';
      sidebar.innerHTML =
        '<h3 style="color:#00A1D6;font-weight:800;font-size:16px;margin-bottom:10px;text-align:center;">üåü Follow These Steps üåü</h3>'+
        '<div style="'+card+'">üßπ From the <strong>Basic</strong> tab, add a <strong>Clear Screen</strong> block inside the on start block to begin fresh.</div>'+
        '<div style="'+card+'">üß© From the <strong>LED</strong> tab, drag a <strong>Set Pixel (x, y, color ‚Äú‚Äù)</strong> block into the workspace.</div>'+
        '<div style="'+card+'">‚û°Ô∏è Set <strong>y = 2</strong> and <strong>x = 0</strong>, and pick a color (e.g. 3 = green).</div>'+
        '<div style="'+card+'">‚ûï Duplicate the block and change <strong>x</strong> from 1 to 7, keeping the same color.</div>'+
        '<div style="'+card+'">üì¶ Make sure all the blocks are inside an <strong>on start</strong> block.</div>'+
        '<div style="'+card+'">‚ñ∂Ô∏è Run your program ‚Äî GlowBit clears then lights a bright colored row of pixels!</div>'+
        '<button id="check-setup-btn" style="display:block;margin:12px auto 6px;padding:8px 14px;border:none;border-radius:6px;background:#00A1D6;color:#fff;font-weight:700;cursor:pointer;">‚úÖ Check Your Setup</button>'+
        '<div class="didyouknow">üé® <strong>Try this!</strong> Change the color number to see different colors on GlowBit (e.g. 1=Red, 3=Green, 5=Blue).</div>';
    }
    overrideSidebar();
    const sid=setInterval(overrideSidebar,400);
    setTimeout(()=>clearInterval(sid),10000);

    /* --- Modal logic --- */
    const modal=document.getElementById('solutionModal');
    function makeDraggable(el){
      const header=document.getElementById('solutionHeader'); if(!header)return;
      let dragging=false,startX=0,startY=0,origLeft=0,origTop=0;
      header.addEventListener('mousedown',e=>{
        e.preventDefault(); dragging=true;
        if(el.style.right&&el.style.right!=='auto'){ el.style.left=el.getBoundingClientRect().left+'px'; el.style.right='auto'; }
        origLeft=parseInt(el.style.left||el.getBoundingClientRect().left,10);
        origTop=parseInt(el.style.top||el.getBoundingClientRect().top,10);
        startX=e.clientX; startY=e.clientY;
        document.addEventListener('mousemove',onDrag);
        document.addEventListener('mouseup',stopDrag);
      });
      function onDrag(e){ if(!dragging)return; el.style.left=(origLeft+(e.clientX-startX))+'px'; el.style.top=(origTop+(e.clientY-startY))+'px'; }
      function stopDrag(){ dragging=false; document.removeEventListener('mousemove',onDrag); document.removeEventListener('mouseup',stopDrag); }
    }

    document.addEventListener('click',e=>{
      if(!e.target)return;
      if(e.target.id==='check-setup-btn'){
        modal.style.display='block';
        modal.setAttribute('aria-hidden','false');
        if(!window._solutionWorkspace){
          try{
            const wsDiv=document.getElementById('solutionWorkspace');
            window._solutionWorkspace=Blockly.inject(wsDiv,{readOnly:true,scrollbars:true,toolbox:null});
            const dom=Blockly.Xml.textToDom(solutionXml);
            Blockly.Xml.domToWorkspace(dom,window._solutionWorkspace);
          }catch(err){console.warn('Solution load failed:',err);}
          makeDraggable(modal);
        }
      }
      if(e.target.id==='solutionClose'||e.target.id==='solutionCloseBtn'){
        modal.style.display='none'; modal.setAttribute('aria-hidden','true');
      }
    });
    document.addEventListener('keydown',ev=>{
      if(ev.key==='Escape'){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }
    });

    if(typeof Glowbit.showIcon==='function') Glowbit.showIcon('smile');
    console.log("‚úÖ Step 5 initialized.");
  })();
  </script>
</body>
</html>
